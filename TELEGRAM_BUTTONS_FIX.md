# –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–Ω–æ–ø–∫–∞–º–∏ Telegram –±–æ—Ç–∞

## –ü—Ä–æ–±–ª–µ–º–∞
–ò–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∏ –≤ Telegram –±–æ—Ç–µ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç (–Ω–µ —Ä–µ–∞–≥–∏—Ä—É—é—Ç –Ω–∞ –Ω–∞–∂–∞—Ç–∏—è).

## –†–µ—à–µ–Ω–∏–µ: –î–≤–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã

### –†–µ–∂–∏–º 1: –ò–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç `callback_data` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–∂–∞—Ç–∏–π –∫–Ω–æ–ø–æ–∫ —á–µ—Ä–µ–∑ webhook.

**–ö–∞–∫ –≤–∫–ª—é—á–∏—Ç—å:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è `TELEGRAM_USE_APP_LINKS` –ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–ª–∏ —Ä–∞–≤–Ω–∞ `false`
- –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ —ç—Ç—É –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- Webhook –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- Endpoint `/api/telegram/webhook` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ HTTPS
- Webhook –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω–∏–º–∞—Ç—å `callback_query` –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –†–µ–∂–∏–º 2: –°—Å—ã–ª–∫–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
–í–º–µ—Å—Ç–æ –∫–Ω–æ–ø–æ–∫ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Å—ã–ª–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –º–µ–Ω—è—é—Ç —Å—Ç–∞—Ç—É—Å —Ç–∞–º.

**–ö–∞–∫ –≤–∫–ª—é—á–∏—Ç—å:**
–î–æ–±–∞–≤—å—Ç–µ –≤ `.env` —Ñ–∞–π–ª:
```env
TELEGRAM_USE_APP_LINKS=true
TELEGRAM_WEBAPP_URL=https://your-app-url.com
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –í–º–µ—Å—Ç–æ –∫–Ω–æ–ø–æ–∫ —Å `callback_data` —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–Ω–æ–ø–∫–∏ —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ (`url`)
2. –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
3. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `action` –∏ `id` –∏–∑ URL
4. –°—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ API endpoint `/api/bookings/[id]/telegram-action`

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å –∫–Ω–æ–ø–∫–∞–º–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ?
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ webhook
curl https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getWebhookInfo
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
- `url` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤–∞—à `/api/telegram/webhook`
- `allowed_updates` —Å–æ–¥–µ—Ä–∂–∏—Ç `["callback_query", "message"]`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: Webhook –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã?
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É. –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è:
```
üì± Received callback query: regular:confirm:xxx-xxx-xxx
```

–ï—Å–ª–∏ —Ç–∞–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç - webhook –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –æ—Ç Telegram.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: Callback query –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è?
–í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
‚úÖ Answered callback query: xxx
üîÑ Processing confirm for regular booking xxx
```

–ï—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ–±–ª–µ–º–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ `callback_query`.

## –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –∏ –Ω—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ:

1. **–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Å—Å—ã–ª–æ–∫:**
   ```env
   TELEGRAM_USE_APP_LINKS=true
   TELEGRAM_WEBAPP_URL=https://your-app-url.com
   ```

2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä**

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
   - –ù–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–Ω–æ–ø–∫–∏-—Å—Å—ã–ª–∫–∏
   - –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
   - –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## API Endpoints

### –û–±—Ä–∞–±–æ—Ç–∫–∞ callback query (–¥–ª—è –∫–Ω–æ–ø–æ–∫)
- **POST** `/api/telegram/webhook`
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `callback_query` –æ—Ç Telegram

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Å—ã–ª–æ–∫ (–¥–ª—è —Ä–µ–∂–∏–º–∞ —Å—Å—ã–ª–æ–∫)
- **GET** `/api/bookings/[id]/telegram-action?action=confirm&type=regular`
- –ú–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫—É

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç –∫–Ω–æ–ø–æ–∫:
```bash
curl -X POST http://localhost:3000/api/telegram/test-buttons \
  -H "Content-Type: application/json" \
  -d '{
    "chat_id": "YOUR_CHAT_ID",
    "booking_id": "test-uuid-here",
    "booking_type": "regular"
  }'
```

### –¢–µ—Å—Ç webhook:
```bash
curl -X POST http://localhost:3000/api/telegram/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "callback_query": {
      "id": "test123",
      "from": {"id": 123456},
      "message": {
        "chat": {"id": 123456},
        "message_id": 1
      },
      "data": "regular:confirm:test-uuid-here"
    }
  }'
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–°–Ω–∞—á–∞–ª–∞ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–µ–∂–∏–º –∫–Ω–æ–ø–æ–∫** - –æ–Ω –±—ã—Å—Ç—Ä–µ–µ –∏ —É–¥–æ–±–Ω–µ–µ
2. **–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** - –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ —Ä–µ–∂–∏–º —Å—Å—ã–ª–æ–∫
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏** - –æ–Ω–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö
4. **–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É `/admin/telegram-webhook` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

