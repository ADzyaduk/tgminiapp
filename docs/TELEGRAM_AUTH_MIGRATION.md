# üöÄ –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ Telegram-only –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é

## üìã –ß—Ç–æ –º—ã —Å–æ–∑–¥–∞–ª–∏

–û—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Å—Ç–∞—Ç—å–µ [—Å Habr](https://habr.com/ru/articles/889270/), –º—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram Mini Apps —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π `initData` –∏ JWT —Ç–æ–∫–µ–Ω–∞–º–∏.

## üõ†Ô∏è –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

- **`composables/useTelegramAuth.ts`** - –æ—Å–Ω–æ–≤–Ω–æ–π composable –¥–ª—è Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- **`server/api/telegram/auth.post.ts`** - –≤–∞–ª–∏–¥–∞—Ü–∏—è initData –∏ –≤—ã–¥–∞—á–∞ JWT —Ç–æ–∫–µ–Ω–æ–≤
- **`server/api/telegram/check-auth.get.ts`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- **`server/api/telegram/logout.post.ts`** - –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
- **`server/api/telegram/update-phone.post.ts`** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- **`middleware/telegram-auth.ts`** - middleware –¥–ª—è –∑–∞—â–∏—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü
- **`plugins/telegram-auth.client.ts`** - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- **`components/TelegramPhoneInput.vue`** - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤–≤–æ–¥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞

### 2. –î–µ–º–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞

- **`pages/telegram-auth.vue`** - –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ –≤–∞—à `.env` —Ñ–∞–π–ª:

```env
# JWT —Å–µ–∫—Ä–µ—Ç—ã –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)
JWT_SECRET=your-very-secure-jwt-secret-here-min-32-chars
JWT_REFRESH_SECRET=your-very-secure-refresh-secret-here-min-32-chars

# –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
TELEGRAM_BOT_TOKEN=your_telegram_bot_token
SUPABASE_URL=your_supabase_url
SUPABASE_KEY=your_supabase_anon_key
```

## üö® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ –¥–ª—è JWT
node -e "console.log('JWT_SECRET=' + require('crypto').randomBytes(64).toString('hex'))"
node -e "console.log('JWT_REFRESH_SECRET=' + require('crypto').randomBytes(64).toString('hex'))"
```

## üéØ –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

### 1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

1. **–ö–ª–∏–µ–Ω—Ç** –ø–æ–ª—É—á–∞–µ—Ç `initData` –∏–∑ Telegram WebApp API
2. **–ö–ª–∏–µ–Ω—Ç** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `initData` –Ω–∞ `/api/telegram/auth`
3. **–°–µ—Ä–≤–µ—Ä** –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç `initData` —Å –ø–æ–º–æ—â—å—é bot token
4. **–°–µ—Ä–≤–µ—Ä** —Å–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
5. **–°–µ—Ä–≤–µ—Ä** –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç Access (15 –º–∏–Ω) –∏ Refresh (7 –¥–Ω–µ–π) JWT —Ç–æ–∫–µ–Ω—ã
6. **–°–µ—Ä–≤–µ—Ä** —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã –≤ HTTP-only cookies
7. **–ö–ª–∏–µ–Ω—Ç** –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω!

### 2. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

1. **–ö–ª–∏–µ–Ω—Ç** –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è cookies)
2. **–°–µ—Ä–≤–µ—Ä** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Access token –∏–∑ cookies
3. –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Refresh token
4. –ï—Å–ª–∏ Refresh token –≤–∞–ª–∏–¥–µ–Ω ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç –æ–±–∞ —Ç–æ–∫–µ–Ω–∞
5. **–°–µ—Ä–≤–µ—Ä** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 3. –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞

- –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —á—Ç–æ –Ω—É–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π API `/api/telegram/update-phone`
- –ù–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π

## üì± –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö

```vue
<script setup>
const { isAuthenticated, isLoading, profile, userName, signOut, updatePhone } =
  useTelegramAuth();
</script>

<template>
  <div v-if="isLoading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <div v-else-if="!isAuthenticated">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>
  <div v-else>
    <h1>–ü—Ä–∏–≤–µ—Ç, {{ userName }}!</h1>
    <p>ID: {{ profile.telegram_id }}</p>
    <button @click="signOut">–í—ã–π—Ç–∏</button>
  </div>
</template>
```

### –ó–∞—â–∏—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü

```vue
<script setup>
// –î–æ–±–∞–≤–∏—Ç—å middleware –¥–ª—è –∑–∞—â–∏—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã
definePageMeta({
  middleware: "telegram-auth",
});
</script>
```

## üîÑ –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

### –®–∞–≥ 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

1. **–ù–µ —Ç—Ä–æ–≥–∞–π—Ç–µ** —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
2. **–î–æ–±–∞–≤—å—Ç–µ** –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ** –Ω–∞ `/telegram-auth`
4. **–£–±–µ–¥–∏—Ç–µ—Å—å** —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –®–∞–≥ 2: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

1. **–ó–∞–º–µ–Ω–∏—Ç–µ** `useAuth` –Ω–∞ `useTelegramAuth` –≤ –Ω–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
2. **–û–±–Ω–æ–≤–∏—Ç–µ** middleware –Ω–∞ `telegram-auth`
3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ** –∫–∞–∂–¥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

### –®–∞–≥ 3: –ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞

1. **–û–±–Ω–æ–≤–∏—Ç–µ** –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
2. **–£–¥–∞–ª–∏—Ç–µ** —Å—Ç—Ä–∞–Ω–∏—Ü—ã `/login` –∏ `/register`
3. **–û—á–∏—Å—Ç–∏—Ç–µ** —Å—Ç–∞—Ä—ã–µ composables –∏ middleware
4. **–û–±–Ω–æ–≤–∏—Ç–µ** –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Supabase

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –≤–∞–ª–∏–¥–∞—Ü–∏—è initData —á–µ—Ä–µ–∑ HMAC
2. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –Ω–µ –Ω—É–∂–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ email
3. **UX** - –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ Telegram
4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram
5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - JWT —Ç–æ–∫–µ–Ω—ã –≤ cookies

## üîç –û—Ç–ª–∞–¥–∫–∞

### Development —Ä–µ–∂–∏–º

- –í `NODE_ENV=development` –≤–∞–ª–∏–¥–∞—Ü–∏—è `initData` –æ—Ç–∫–ª—é—á–µ–Ω–∞
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ñ–µ–π–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ Telegram Bot

### –õ–æ–≥–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
curl -b cookies.txt http://localhost:3000/api/telegram/check-auth

# –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
curl -X POST http://localhost:3000/api/telegram/auth \
  -H "Content-Type: application/json" \
  -d '{"initData":"fake_data_for_dev"}'
```

### –û—Ç–ª–∞–¥–∫–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ

```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
console.log("TG Data:", window.Telegram?.WebApp?.initData);
console.log("Auth state:", document.cookie);
```

## üö® –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **HTTPS –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω** –¥–ª—è production
2. **JWT —Å–µ–∫—Ä–µ—Ç—ã** –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –∏ —Å–ª–æ–∂–Ω—ã–º–∏
3. **HTTP-only cookies** –∑–∞—â–∏—â–∞—é—Ç –æ—Ç XSS
4. **SameSite=lax** –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç CSRF
5. **–í–∞–ª–∏–¥–∞—Ü–∏—è initData** –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥–¥–µ–ª–∫—É

## üåê Production –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å

- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è `initData` —á–µ—Ä–µ–∑ bot token
- ‚úÖ JWT —Ç–æ–∫–µ–Ω—ã —Å –∫–æ—Ä–æ—Ç–∫–∏–º –≤—Ä–µ–º–µ–Ω–µ–º –∂–∏–∑–Ω–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ HTTP-only cookies
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF –∏ XSS
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π

## üéâ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è, –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram, –∫–æ—Ç–æ—Ä–∞—è:

- üöÄ **–ë—ã—Å—Ç—Ä–∞—è** - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ –æ–¥–∏–Ω –∫–ª–∏–∫
- üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è** - –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram
- üéØ **–ü—Ä–æ—Å—Ç–∞—è** - –Ω–µ –Ω—É–∂–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- üì± **–£–¥–æ–±–Ω–∞—è** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
- üõ†Ô∏è **–ù–∞–¥–µ–∂–Ω–∞—è** - JWT —Ç–æ–∫–µ–Ω—ã –∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
