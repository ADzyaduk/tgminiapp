# Исправление проблемы с регистрацией

## Проблема

При регистрации пользователя письмо подтверждения отправляется, но возникают проблемы с авторизацией после подтверждения email. Это происходит потому, что:

1. **Пользователь регистрируется в `auth.users`** (Supabase Auth) ✅
2. **Отправляется письмо подтверждения** ✅  
3. **НО профиль в таблице `profiles` не создается автоматически** ❌
4. **При попытке входа система ищет профиль в `profiles`, но не находит его** ❌

## Решение

Нужно выполнить SQL-скрипт в вашей базе данных Supabase.

## Шаги для исправления

### 1. Выполните SQL-скрипт в Supabase Dashboard

1. Откройте [Supabase Dashboard](https://app.supabase.com)
2. Перейдите в ваш проект
3. Откройте раздел **SQL Editor**
4. **ВАРИАНТ A (рекомендуется):** Скопируйте и выполните содержимое файла `database/fix-profile-trigger-simple.sql`
5. **ВАРИАНТ B:** Если нужны дополнительные политики, используйте полный файл `database/fix-profile-trigger.sql`

**⚠️ Если получаете ошибки о существующих политиках** - используйте упрощенную версию `fix-profile-trigger-simple.sql`

### 2. Что делает этот скрипт

1. **Создает функцию `handle_new_user()`** - автоматически создает профиль при регистрации
2. **Создает триггер `on_auth_user_created`** - запускает функцию при добавлении нового пользователя в `auth.users`
3. **Создает профили для существующих пользователей** - если у вас уже есть пользователи без профилей
4. **Настраивает политики безопасности** (только в полной версии)

### 3. Проверка работы

После выполнения скрипта:

1. **Новые пользователи** будут автоматически получать профиль при регистрации
2. **Существующие пользователи** получат профили (если их еще не было)

## Проверка работы регистрации

1. Зайдите на страницу регистрации
2. Заполните форму
3. Подтвердите email
4. Попробуйте войти в систему

Теперь все должно работать правильно!

## Что было исправлено

- ✅ Автоматическое создание профиля при регистрации
- ✅ Восстановление профилей для существующих пользователей
- ✅ Правильные политики безопасности для профилей (в полной версии)
- ✅ Функция для управления ролями пользователей (в полной версии)
- ✅ Поддержка метаданных из формы регистрации (имя, телефон)

## Структура данных

После исправления при регистрации:

1. **В `auth.users`** создается запись с учетными данными
2. **В `profiles`** автоматически создается профиль с:
   - `id` - такой же как в `auth.users`
   - `email` - копируется из `auth.users`
   - `name` - из метаданных регистрации
   - `phone` - из метаданных регистрации  
   - `role` - по умолчанию 'user'

## Различия между версиями скриптов

### `fix-profile-trigger-simple.sql` (рекомендуется)
- ✅ Создает триггер для автоматического создания профилей
- ✅ Восстанавливает профили для существующих пользователей
- ✅ Не изменяет существующие политики безопасности

### `fix-profile-trigger.sql` (полная версия)
- ✅ Все из простой версии
- ✅ Пересоздает политики безопасности
- ✅ Добавляет функцию управления ролями для админов
- ⚠️ Может конфликтовать с существующими политиками 