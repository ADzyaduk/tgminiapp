# Telegram Уведомления

## Обязательные переменные окружения

- `TELEGRAM_BOT_TOKEN` – токен бота из BotFather. Без него любые запросы к Bot API будут проигнорированы.
- `TELEGRAM_ADMIN_CHAT_ID` – чат администратора, куда падают уведомления, если нет менеджеров лодки.

## Как работают уведомления

1. При создании нового бронирования автоматически отправляется уведомление администраторам и менеджерам лодки.
2. При изменении статуса бронирования клиент получает уведомление (если у него заполнен `telegram_id`).
3. Уведомления отправляются через `server/utils/telegram-notifications.ts` используя общий клиент `server/utils/telegram-client.ts`.

## Типы уведомлений

### Для администраторов/менеджеров:
- Новое бронирование (обычное или групповое)
- Уведомления отправляются менеджерам лодки, если они назначены, иначе администратору

### Для клиентов:
- Подтверждение получения бронирования
- Изменение статуса бронирования (подтверждено/отменено)
- Напоминания о предстоящем бронировании

## Где смотреть логи

- **Локально:** терминал, где запущен `npm run dev`.
- **PM2:** `pm2 logs tgminiapp`.
- **Docker:** `docker logs <container>`.

Все ошибки отправки уведомлений выводятся в консоль сервера.

## Тестирование уведомлений

Используйте API endpoint `/api/telegram/test-notifications` для тестирования различных типов уведомлений.

## Inline кнопки в уведомлениях о бронировании

В уведомлениях о новых бронированиях добавлены inline кнопки "✅ Подтвердить" и "❌ Отменить".

### Настройка webhook для обработки callback

Для работы inline кнопок необходимо настроить webhook в Telegram Bot API:

```bash
# Установить webhook (замените YOUR_DOMAIN на ваш домен)
curl -X POST "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://YOUR_DOMAIN/api/telegram/callback",
    "allowed_updates": ["callback_query"]
  }'
```

### Проверка webhook

```bash
# Проверить текущий webhook
curl "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getWebhookInfo"
```

### Как это работает

1. При создании нового бронирования отправляется уведомление менеджерам с inline кнопками
2. При нажатии на кнопку Telegram отправляет callback_query на `/api/telegram/callback`
3. Endpoint обрабатывает callback, обновляет статус бронирования в БД
4. Отправляется уведомление клиенту об изменении статуса
5. Сообщение в Telegram обновляется, кнопки убираются

### Формат callback_data

- `booking_confirm_regular_<bookingId>` - подтвердить обычное бронирование
- `booking_cancel_regular_<bookingId>` - отменить обычное бронирование
- `booking_confirm_group_trip_<bookingId>` - подтвердить групповую поездку
- `booking_cancel_group_trip_<bookingId>` - отменить групповую поездку